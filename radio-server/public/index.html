<!doctype html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Radio Comunitaria Pinto Los Pellines</title>
    <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        min-height: 100vh;
      }

      .container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 20px;
      }

      .header {
        text-align: center;
        margin-bottom: 30px;
      }

      .header h1 {
        font-size: 2.5rem;
        margin-bottom: 10px;
        text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
      }

      .header p {
        font-size: 1.2rem;
        opacity: 0.9;
      }

      .radio-player {
        background: rgba(255, 255, 255, 0.1);
        border-radius: 15px;
        padding: 30px;
        margin-bottom: 30px;
        -webkit-backdrop-filter: blur(10px);
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.2);
      }

      .status {
        text-align: center;
        margin-bottom: 20px;
      }

      .status.live {
        color: #ff4757;
        font-weight: bold;
      }

      .status.offline {
        color: #7bed9f;
      }

      .now-playing {
        text-align: center;
        margin-bottom: 20px;
      }

      .now-playing h3 {
        margin-bottom: 10px;
      }

      .controls {
        display: flex;
        justify-content: center;
        gap: 15px;
        margin-bottom: 20px;
      }

      .btn {
        padding: 12px 24px;
        border: none;
        border-radius: 25px;
        font-size: 16px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        text-transform: uppercase;
        letter-spacing: 1px;
      }

      .btn-primary {
        background: #ff6b6b;
        color: white;
      }

      .btn-primary:hover {
        background: #ff5252;
        transform: translateY(-2px);
      }

      .btn-secondary {
        background: #3742fa;
        color: white;
      }

      .btn-secondary:hover {
        background: #2f3542;
        transform: translateY(-2px);
      }

      .btn-success {
        background: #2ed573;
        color: white;
      }

      .btn-success:hover {
        background: #26a65b;
        transform: translateY(-2px);
      }

      .btn-danger {
        background: #ff3838;
        color: white;
      }

      .btn-danger:hover {
        background: #ff1e1e;
        transform: translateY(-2px);
      }

      .upload-section {
        background: rgba(255, 255, 255, 0.1);
        border-radius: 15px;
        padding: 30px;
        margin-bottom: 30px;
        -webkit-backdrop-filter: blur(10px);
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.2);
      }

      .upload-form {
        display: flex;
        flex-direction: column;
        gap: 15px;
      }

      .form-group {
        display: flex;
        flex-direction: column;
      }

      .form-group label {
        margin-bottom: 5px;
        font-weight: 600;
      }

      .form-group input,
      .form-group textarea {
        padding: 12px;
        border: none;
        border-radius: 8px;
        font-size: 16px;
        background: rgba(255, 255, 255, 0.9);
        color: #333;
      }

      .form-group textarea {
        resize: vertical;
        min-height: 80px;
      }

      .playlist {
        background: rgba(255, 255, 255, 0.1);
        border-radius: 15px;
        padding: 30px;
        -webkit-backdrop-filter: blur(10px);
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.2);
      }

      .playlist h2 {
        margin-bottom: 20px;
        text-align: center;
      }

      .track-list {
        max-height: 400px;
        overflow-y: auto;
      }

      .track {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 15px;
        background: rgba(255, 255, 255, 0.05);
        margin-bottom: 10px;
        border-radius: 10px;
        transition: all 0.3s ease;
      }

      .track:hover {
        background: rgba(255, 255, 255, 0.1);
      }

      .track.current {
        background: rgba(255, 255, 255, 0.2);
        border-left: 4px solid #ff6b6b;
      }

      .track-info {
        flex: 1;
      }

      .track-title {
        font-weight: 600;
        margin-bottom: 5px;
      }

      .track-artist {
        opacity: 0.8;
        font-size: 14px;
      }

      .track-actions {
        display: flex;
        gap: 10px;
      }

      .track-btn {
        padding: 8px 16px;
        border: none;
        border-radius: 15px;
        font-size: 14px;
        cursor: pointer;
        transition: all 0.3s ease;
      }

      .track-btn.play {
        background: #2ed573;
        color: white;
      }

      .track-btn.delete {
        background: #ff3838;
        color: white;
      }

      .stats {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
      }

      .stat-card {
        background: rgba(255, 255, 255, 0.1);
        border-radius: 10px;
        padding: 20px;
        text-align: center;
        -webkit-backdrop-filter: blur(10px);
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.2);
      }

      .stat-value {
        font-size: 2rem;
        font-weight: bold;
        margin-bottom: 5px;
      }

      .stat-label {
        opacity: 0.8;
      }

      .live-controls {
        background: rgba(255, 255, 255, 0.1);
        border-radius: 15px;
        padding: 30px;
        margin-bottom: 30px;
        -webkit-backdrop-filter: blur(10px);
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.2);
      }

      .live-form {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 15px;
      }

      .live-form-submit {
        margin-top: 20px;
      }

      .empty-playlist {
        text-align: center;
        opacity: 0.7;
      }

      @media (max-width: 768px) {
        .container {
          padding: 10px;
        }

        .header h1 {
          font-size: 2rem;
        }

        .live-form {
          grid-template-columns: 1fr;
        }

        .controls {
          flex-direction: column;
          align-items: center;
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="header">
        <h1>üìª Radio Comunitaria Pinto Los Pellines</h1>
        <p>La voz de nuestra comunidad</p>
      </div>

      <div class="stats">
        <div class="stat-card">
          <div class="stat-value" id="listeners">0</div>
          <div class="stat-label">Oyentes Conectados</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="tracks">0</div>
          <div class="stat-label">Canciones en Playlist</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="status">Offline</div>
          <div class="stat-label">Estado de Transmisi√≥n</div>
        </div>
      </div>

      <div class="radio-player">
        <div class="status" id="status-indicator">
          <span class="offline">‚óè Sistema Offline</span>
        </div>

        <div class="now-playing">
          <h3 id="current-title">Ninguna canci√≥n reproduci√©ndose</h3>
          <p id="current-artist">Artista desconocido</p>
        </div>

        <div class="controls">
          <button class="btn btn-primary" id="start-live">
            Iniciar Transmisi√≥n en Vivo
          </button>
          <button class="btn btn-danger" id="stop-live">
            Detener Transmisi√≥n
          </button>
          <button class="btn btn-secondary" id="refresh-status">
            Actualizar Estado
          </button>
        </div>
      </div>

      <div class="live-controls">
        <h2>üéôÔ∏è Controles de Transmisi√≥n en Vivo</h2>
        <form class="live-form" id="live-form">
          <div class="form-group">
            <label for="live-title">T√≠tulo del Programa:</label>
            <input
              type="text"
              id="live-title"
              placeholder="Ej: Programa Comunitario"
            />
          </div>
          <div class="form-group">
            <label for="live-artist">Presentador/Artista:</label>
            <input
              type="text"
              id="live-artist"
              placeholder="Ej: Comunidad Local"
            />
          </div>
          <div class="form-group">
            <label for="live-description">Descripci√≥n:</label>
            <textarea
              id="live-description"
              placeholder="Describe tu programa en vivo..."
            ></textarea>
          </div>
          <div class="form-group">
            <button type="submit" class="btn btn-success live-form-submit">
              Actualizar Metadatos
            </button>
          </div>
        </form>
      </div>

      <div class="upload-section">
        <h2>üì§ Subir Nueva Canci√≥n</h2>
        <form
          class="upload-form"
          id="upload-form"
          enctype="multipart/form-data"
        >
          <div class="form-group">
            <label for="audio-file">Archivo de Audio:</label>
            <input type="file" id="audio-file" accept="audio/*" required />
          </div>
          <div class="form-group">
            <label for="track-title">T√≠tulo de la Canci√≥n:</label>
            <input
              type="text"
              id="track-title"
              placeholder="T√≠tulo de la canci√≥n"
              required
            />
          </div>
          <div class="form-group">
            <label for="track-artist">Artista:</label>
            <input
              type="text"
              id="track-artist"
              placeholder="Nombre del artista"
              required
            />
          </div>
          <button type="submit" class="btn btn-success">Subir Canci√≥n</button>
        </form>
      </div>

      <div class="playlist">
        <h2>üìã Playlist</h2>
        <div class="track-list" id="track-list">
          <p class="empty-playlist">No hay canciones en la playlist a√∫n.</p>
        </div>
      </div>
    </div>

    <script>
      const socket = io();
      let currentAudio = null;
      let playlist = [];

      // DOM elements
      const statusIndicator = document.getElementById('status-indicator');
      const currentTitle = document.getElementById('current-title');
      const currentArtist = document.getElementById('current-artist');
      const listenersCount = document.getElementById('listeners');
      const tracksCount = document.getElementById('tracks');
      const statusValue = document.getElementById('status');
      const uploadForm = document.getElementById('upload-form');
      const liveForm = document.getElementById('live-form');
      const trackList = document.getElementById('track-list');
      const startLiveBtn = document.getElementById('start-live');
      const stopLiveBtn = document.getElementById('stop-live');
      const refreshBtn = document.getElementById('refresh-status');

      // Initialize audio player
      function initAudioPlayer() {
        currentAudio = new Audio();
        currentAudio.crossOrigin = 'anonymous';

        currentAudio.addEventListener('error', e => {
          console.error('Audio error:', e);
        });
      }

      // Update UI with status
      function updateStatus(data) {
        listenersCount.textContent = data.listeners || 0;
        tracksCount.textContent = data.playlist?.length || 0;

        if (data.isLive) {
          statusIndicator.innerHTML = '<span class="live">‚óè EN VIVO</span>';
          statusValue.textContent = 'En Vivo';
          currentTitle.textContent =
            data.metadata?.title || 'Transmisi√≥n en Vivo';
          currentArtist.textContent = data.metadata?.artist || 'Presentador';
        } else {
          statusIndicator.innerHTML =
            '<span class="offline">‚óè Sistema Offline</span>';
          statusValue.textContent = 'Offline';
          if (data.currentTrack) {
            currentTitle.textContent = data.currentTrack.title;
            currentArtist.textContent = data.currentTrack.artist;
          } else {
            currentTitle.textContent = 'Ninguna canci√≥n reproduci√©ndose';
            currentArtist.textContent = 'Artista desconocido';
          }
        }
      }

      // Render playlist
      function renderPlaylist(tracks, currentTrack) {
        if (!tracks || tracks.length === 0) {
          trackList.innerHTML =
            '<p style="text-align: center; opacity: 0.7;">No hay canciones en la playlist a√∫n.</p>';
          return;
        }

        trackList.innerHTML = tracks
          .map(
            track => `
                <div class="track ${currentTrack && currentTrack.id === track.id ? 'current' : ''}">
                    <div class="track-info">
                        <div class="track-title">${track.title}</div>
                        <div class="track-artist">${track.artist}</div>
                    </div>
                    <div class="track-actions">
                        <button class="track-btn play" onclick="playTrack('${track.id}')">Reproducir</button>
                        <button class="track-btn delete" onclick="deleteTrack('${track.id}')">Eliminar</button>
                    </div>
                </div>
            `
          )
          .join('');
      }

      // Socket event handlers
      socket.on('status', data => {
        console.log('Status update:', data);
        updateStatus(data);
        playlist = data.playlist || [];
        renderPlaylist(playlist, data.currentTrack);
      });

      socket.on('track-added', track => {
        console.log('Track added:', track);
        playlist.push(track);
        renderPlaylist(playlist, null);
        tracksCount.textContent = playlist.length;
      });

      socket.on('track-removed', trackId => {
        console.log('Track removed:', trackId);
        playlist = playlist.filter(t => t.id !== trackId);
        renderPlaylist(playlist, null);
        tracksCount.textContent = playlist.length;
      });

      socket.on('track-changed', data => {
        console.log('Track changed:', data);
        renderPlaylist(playlist, data.track);
        updateStatus({ ...data, isLive: false });
      });

      socket.on('live-started', metadata => {
        console.log('Live started:', metadata);
        updateStatus({ isLive: true, metadata });
      });

      socket.on('live-stopped', () => {
        console.log('Live stopped');
        updateStatus({ isLive: false });
      });

      // Event handlers
      uploadForm.addEventListener('submit', async e => {
        e.preventDefault();

        const formData = new FormData();
        formData.append(
          'audio',
          document.getElementById('audio-file').files[0]
        );
        formData.append('title', document.getElementById('track-title').value);
        formData.append(
          'artist',
          document.getElementById('track-artist').value
        );

        try {
          const response = await fetch('/upload', {
            method: 'POST',
            body: formData,
          });

          const result = await response.json();

          if (result.success) {
            alert('Canci√≥n subida exitosamente!');
            uploadForm.reset();
          } else {
            alert('Error al subir la canci√≥n: ' + result.error);
          }
        } catch (error) {
          console.error('Upload error:', error);
          alert('Error al subir la canci√≥n');
        }
      });

      liveForm.addEventListener('submit', async e => {
        e.preventDefault();

        const metadata = {
          title: document.getElementById('live-title').value,
          artist: document.getElementById('live-artist').value,
          description: document.getElementById('live-description').value,
        };

        try {
          const response = await fetch('/live/start', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify(metadata),
          });

          const result = await response.json();

          if (result.success) {
            alert('Transmisi√≥n en vivo iniciada!');
          } else {
            alert('Error al iniciar transmisi√≥n: ' + result.error);
          }
        } catch (error) {
          console.error('Live start error:', error);
          alert('Error al iniciar transmisi√≥n');
        }
      });

      startLiveBtn.addEventListener('click', async () => {
        try {
          const response = await fetch('/live/start', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({
              title: 'Transmisi√≥n en Vivo',
              artist: 'Comunidad Local',
              description: 'Programa en vivo desde Pinto Los Pellines',
            }),
          });

          const result = await response.json();

          if (result.success) {
            alert('Transmisi√≥n en vivo iniciada!');
          }
        } catch (error) {
          console.error('Live start error:', error);
          alert('Error al iniciar transmisi√≥n');
        }
      });

      stopLiveBtn.addEventListener('click', async () => {
        try {
          const response = await fetch('/live/stop', { method: 'POST' });
          const result = await response.json();

          if (result.success) {
            alert('Transmisi√≥n detenida!');
          }
        } catch (error) {
          console.error('Live stop error:', error);
          alert('Error al detener transmisi√≥n');
        }
      });

      refreshBtn.addEventListener('click', () => {
        socket.emit('request-status');
      });

      // Global functions for track actions
      window.playTrack = async trackId => {
        try {
          const response = await fetch(`/track/${trackId}`, { method: 'POST' });
          const result = await response.json();

          if (result.success) {
            console.log('Track changed to:', result.track.title);
          }
        } catch (error) {
          console.error('Play track error:', error);
          alert('Error al reproducir canci√≥n');
        }
      };

      window.deleteTrack = async trackId => {
        if (!confirm('¬øEst√°s seguro de que quieres eliminar esta canci√≥n?')) {
          return;
        }

        try {
          const response = await fetch(`/track/${trackId}`, {
            method: 'DELETE',
          });
          const result = await response.json();

          if (result.success) {
            console.log('Track deleted successfully');
          }
        } catch (error) {
          console.error('Delete track error:', error);
          alert('Error al eliminar canci√≥n');
        }
      };

      // Initialize
      initAudioPlayer();
      socket.emit('request-status');
    </script>
  </body>
</html>
